schema: '2.0'
stages:
  pull_data:
    cmd: mkdir -p data/raw && poetry run kaggle competitions download -c playground-series-s4e12
      && mv playground-series-s4e12.zip data/raw/ && cd data/raw/ && unzip playground-series-s4e12.zip
      && rm playground-series-s4e12.zip
    outs:
    - path: data/raw
      hash: md5
      md5: 81fcdcb7e37e0ac83770494236eb8c60.dir
      size: 332735146
      nfiles: 3
  prepare_basic:
    cmd: poetry run python insurance/prepare_basic.py
    deps:
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 00dbd77a25f2125a8a07e5124b2560ac
      size: 7598
    - path: insurance/prepare_basic.py
      hash: md5
      md5: ca626a5ef80b84e9975f02f65dc96db5
      size: 2016
    params:
      params.yaml:
        data.random_state: 42
    outs:
    - path: data/prepared/test_data.feather
      hash: md5
      md5: 9c65dae12868d8646abe9faae5844859
      size: 92158186
    - path: data/prepared/train_data.feather
      hash: md5
      md5: f228b8b2ecd5070de22fa23efb59c33e
      size: 143144866
    - path: out/data_pipeline_train.pkl
      hash: md5
      md5: edfc8dc0eed08649f284511bf15eb63c
      size: 1912
  train_basic:
    cmd: poetry run python insurance/train_basic.py
    deps:
    - path: data/prepared/prepared_data.csv
      hash: md5
      md5: be6d2a66bbfc1ca11856fe43b15f938d
      size: 164008012
    - path: insurance/train_basic.py
      hash: md5
      md5: 1087798e3a88729a780248839e5d4271
      size: 4474
    outs:
    - path: out/models/model_basic.pkl
      hash: md5
      md5: 4b8a371d04e5278a135523ea5aa7dc66
      size: 145233
  train@basic:
    cmd: poetry run python insurance/train_basic.py
    deps:
    - path: data/prepared/prepared_imputed_data.feather
      hash: md5
      md5: 540c4b236beb05faeda036c5adbd7429
      size: 58049042
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 3eec6e7d1c5eea1daccba3532417f362
      size: 3245
    - path: insurance/train_basic.py
      hash: md5
      md5: 5c9c38071cc78463eb8fc2abba4f039d
      size: 4636
    params:
      params.yaml:
        train.basic:
        train.n_splits: 5
        train.random_state: 42
    outs:
    - path: out/models/data_pipeline_basic.pkl
      hash: md5
      md5: b96209877d55303005fe34d2e0e03e1e
      size: 33615
    - path: out/models/model_basic.pkl
      hash: md5
      md5: b96209877d55303005fe34d2e0e03e1e
      size: 33615
  train@xgboost:
    cmd: poetry run python insurance/train_xgboost.py
    deps:
    - path: data/prepared/prepared_imputed_data.feather
      hash: md5
      md5: 540c4b236beb05faeda036c5adbd7429
      size: 58049042
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 3eec6e7d1c5eea1daccba3532417f362
      size: 3245
    - path: insurance/train_xgboost.py
      hash: md5
      md5: ceabdaa0b46f136e34303f08a369764a
      size: 3203
    params:
      params.yaml:
        train.n_splits: 5
        train.random_state: 42
        train.xgboost:
          random_state: 42
          device: cuda
          objective: reg:squarederror
          eval_metric: rmse
          booster: gbtree
          lambda: 0.4104749889610154
          alpha: 5.561529990659432e-07
          subsample: 0.9814736188143719
          colsample_bytree: 0.7240915982708991
          max_depth: 7
          min_child_weight: 9
          eta: 0.4324358241129275
          gamma: 2.865477838059048e-06
          grow_policy: depthwise
    outs:
    - path: out/models/data_pipeline_xgboost.pkl
      hash: md5
      md5: fd9986981188f504b8a7d9f9dc67e68c
      size: 1204
    - path: out/models/model_xgboost.pkl
      hash: md5
      md5: f5ed57c419ce8b7331f89ce3f08d82a2
      size: 33002
  train_imputer:
    cmd: poetry run python insurance/train_imputer.py
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: be9be223edd7835c118acb707733196d
      size: 57045410
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 5b3ebe7bd623c9cb606fc8f0e2735e76
      size: 3308
    - path: insurance/train_imputer.py
      hash: md5
      md5: 392f99313c616f6202db27b2ced378f6
      size: 7028
    params:
      params.yaml:
        torch_imputer:
          epochs: 50
          lr: 0.001
          batch_size: 2048
    outs:
    - path: out/models/torch_imputer.pt
      hash: md5
      md5: 7537c1a3a36c27d5b0852c44e8090698
      size: 6340
    - path: out/models/torch_imputer_data_pipeline.pkl
      hash: md5
      md5: 366088dae5e98c16271032306fbaf220
      size: 3037
  impute:
    cmd: poetry run python insurance/run_imputer.py
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: be9be223edd7835c118acb707733196d
      size: 57045410
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 5b3ebe7bd623c9cb606fc8f0e2735e76
      size: 3308
    - path: insurance/run_imputer.py
      hash: md5
      md5: 0ea052fdd86050efeb668dcd5d59a08f
      size: 2531
    - path: out/models/torch_imputer.pt
      hash: md5
      md5: 7537c1a3a36c27d5b0852c44e8090698
      size: 6340
    - path: out/models/torch_imputer_data_pipeline.pkl
      hash: md5
      md5: 366088dae5e98c16271032306fbaf220
      size: 3037
    outs:
    - path: data/prepared/prepared_imputed_data.feather
      hash: md5
      md5: c34e946b732269f7b58cb0542bd73620
      size: 56337066
  tune_xboost:
    cmd: poetry run python insurance/tune_xgboost.py data/prepared/prepared_data.feather
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: be9be223edd7835c118acb707733196d
      size: 57045410
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 62daeae84ed48ce63fd650e97c9736be
      size: 5106
    - path: insurance/tune_xgboost.py
      hash: md5
      md5: 7ba6c082008e87c59d02b391dfd02ec4
      size: 5804
    outs:
    - path: out/xgboost_model_params.yaml
      hash: md5
      md5: 11bca7628477bb73deaa189557db0d33
      size: 250
  train_xgboost:
    cmd: poetry run python insurance/train_xgboost.py data/prepared/prepared_data.feather
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: 6f2ff9d50624a8441f17f3daf678d382
      size: 51335522
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 897e1f4a9ef10c76b81702a02a199e7e
      size: 7774
    - path: insurance/train_xgboost.py
      hash: md5
      md5: 32e46391afae6516909fcae0202a4701
      size: 5263
    outs:
    - path: out/data_pipeline_train_xgboost.pkl
      hash: md5
      md5: 288caf55440aa23caea534b6500dec9b
      size: 10389
    - path: out/models/xgboost_model.pkl
      hash: md5
      md5: 4cdf9a14bf9c6a64c187a3e2b4cdc744
      size: 163206875
  train_catboost:
    cmd: poetry run python insurance/train_catboost.py data/prepared/prepared_data.feather
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: 6f2ff9d50624a8441f17f3daf678d382
      size: 51335522
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 897e1f4a9ef10c76b81702a02a199e7e
      size: 7774
    - path: insurance/train_catboost.py
      hash: md5
      md5: 363d930f85c4d8a4aaf7efed753a485e
      size: 6370
    outs:
    - path: out/data_pipeline_train_catboost.pkl
      hash: md5
      md5: 288caf55440aa23caea534b6500dec9b
      size: 10389
    - path: out/models/catboost_model.pkl
      hash: md5
      md5: 60e20b164c1bd71dad9117e0f1083ad1
      size: 4706669
  train_ensemble:
    cmd: poetry run python insurance/train_ensemble.py --previous-layer 1
    deps:
    - path: data/oof/layer_1.feather
      hash: md5
      md5: 4afc5c8339318d2094120922336303c7
      size: 160835146
    - path: data/preds/layer_1.feather
      hash: md5
      md5: 73f26f76e11bf64fdb1731409906a943
      size: 106831570
    - path: insurance/train_ensemble.py
      hash: md5
      md5: 294024c6e7281ed50439f4936cb526cc
      size: 6492
    params:
      params.yaml:
        ensemble:
          random_state: 42
    outs:
    - path: out/data_pipeline_train_ensemble.pkl
      hash: md5
      md5: 332ae5bcdbc39975df3b8dc61be53aba
      size: 3119
    - path: out/preds.csv
      hash: md5
      md5: 52b442f773fe65e7de048d6d9193a54e
      size: 21088723
  train_lgbm:
    cmd: poetry run python insurance/train_lgbm.py data/prepared/prepared_data.feather
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: 6f2ff9d50624a8441f17f3daf678d382
      size: 51335522
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 897e1f4a9ef10c76b81702a02a199e7e
      size: 7774
    - path: insurance/train_lgbm.py
      hash: md5
      md5: ba41f74e6f73c8d8878802b8ea912e43
      size: 4366
    outs:
    - path: out/data_pipeline_train_lgbm.pkl
      hash: md5
      md5: 288caf55440aa23caea534b6500dec9b
      size: 10389
    - path: out/models/lgbm_model.pkl
      hash: md5
      md5: fa3ab5071b8343ee2b08651f1d35f928
      size: 3094715
  train_layer_0@xgboost:
    cmd: poetry run python insurance/train_xgboost.py --layer 0 --model-name xgboost
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: 6f2ff9d50624a8441f17f3daf678d382
      size: 51335522
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 897e1f4a9ef10c76b81702a02a199e7e
      size: 7774
    - path: insurance/train_xgboost.py
      hash: md5
      md5: b0ce08c44dfdd48eeb0c0a68c2738538
      size: 4205
    outs:
    - path: data/oof/xgboost_layer_0.feather
      hash: md5
      md5: 9ff83257916b443774b6a2938000de27
      size: 141852058
    - path: out/data_pipeline_train_xgboost.pkl
      hash: md5
      md5: 2af72c0bb82caf36e0675d059918d2e5
      size: 10424
    - path: out/models/xgboost_model_layer_0.pkl
      hash: md5
      md5: 5332db1d9a9c52905ef760803a9ec4da
      size: 144016852
  train_layer_1@xgboost:
    cmd: poetry run python insurance/train_xgboost.py --layer 1 --model-name xgboost
    deps:
    - path: data/oof/catboost_layer_0.feather
      hash: md5
      md5: 8ba0c284116c51b2caaac17554f6fca1
      size: 145258162
    - path: data/oof/lgbm_layer_0.feather
      hash: md5
      md5: b15859f9d6cd8bac6a7ce1b311fef157
      size: 145258138
    - path: data/oof/xgboost_layer_0.feather
      hash: md5
      md5: 9ff83257916b443774b6a2938000de27
      size: 141852058
    - path: insurance/train_xgboost.py
      hash: md5
      md5: b0ce08c44dfdd48eeb0c0a68c2738538
      size: 4205
    outs:
    - path: data/oof/xgboost_layer_1.feather
      hash: md5
      md5: f052c525f9beed50150dfcda73f49414
      size: 167216986
    - path: out/models/xgboost_model_layer_1.pkl
      hash: md5
      md5: b588d473ce6a612dd508961074119b81
      size: 479510
  train_layer_0@catboost:
    cmd: poetry run python insurance/train_catboost.py --layer 0 --model-name catboost
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: 6f2ff9d50624a8441f17f3daf678d382
      size: 51335522
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 897e1f4a9ef10c76b81702a02a199e7e
      size: 7774
    - path: insurance/train_catboost.py
      hash: md5
      md5: e3ec18a1dc272c7e5adfd49301158f40
      size: 5502
    outs:
    - path: data/oof/catboost_layer_0.feather
      hash: md5
      md5: 8ba0c284116c51b2caaac17554f6fca1
      size: 145258162
    - path: out/data_pipeline_train_catboost.pkl
      hash: md5
      md5: 2af72c0bb82caf36e0675d059918d2e5
      size: 10424
    - path: out/models/catboost_model_layer_0.pkl
      hash: md5
      md5: 11031604b2eaf2f88a01ff3fcfb5612b
      size: 5254677
  train_layer_0@lgbm:
    cmd: poetry run python insurance/train_lgbm.py --layer 0 --model-name lgbm
    deps:
    - path: data/prepared/prepared_data.feather
      hash: md5
      md5: 6f2ff9d50624a8441f17f3daf678d382
      size: 51335522
    - path: insurance/data_pipeline.py
      hash: md5
      md5: 897e1f4a9ef10c76b81702a02a199e7e
      size: 7774
    - path: insurance/train_lgbm.py
      hash: md5
      md5: 82500739892e18721142e3f69744a64b
      size: 3669
    outs:
    - path: data/oof/lgbm_layer_0.feather
      hash: md5
      md5: b15859f9d6cd8bac6a7ce1b311fef157
      size: 145258138
    - path: out/data_pipeline_train_lgbm.pkl
      hash: md5
      md5: 2af72c0bb82caf36e0675d059918d2e5
      size: 10424
    - path: out/models/lgbm_model_layer_0.pkl
      hash: md5
      md5: 445ee0c4b060cfc9e4063003fa7ca1fd
      size: 3093608
  train_layer_1@lgbm:
    cmd: poetry run python insurance/train_lgbm.py --layer 1 --model-name lgbm
    deps:
    - path: data/oof/catboost_layer_0.feather
      hash: md5
      md5: 8ba0c284116c51b2caaac17554f6fca1
      size: 145258162
    - path: data/oof/lgbm_layer_0.feather
      hash: md5
      md5: b15859f9d6cd8bac6a7ce1b311fef157
      size: 145258138
    - path: data/oof/xgboost_layer_0.feather
      hash: md5
      md5: 9ff83257916b443774b6a2938000de27
      size: 141852058
    - path: insurance/train_lgbm.py
      hash: md5
      md5: 82500739892e18721142e3f69744a64b
      size: 3669
    outs:
    - path: data/oof/lgbm_layer_1.feather
      hash: md5
      md5: 5d192e353acddea514ad9bc717448d85
      size: 170659114
    - path: out/models/lgbm_model_layer_1.pkl
      hash: md5
      md5: 360585f8ee2d973ff8d2a98ca62515ad
      size: 1484136
  train_layer_1@catboost:
    cmd: poetry run python insurance/train_catboost.py --layer 1 --model-name catboost
    deps:
    - path: data/oof/catboost_layer_0.feather
      hash: md5
      md5: 8ba0c284116c51b2caaac17554f6fca1
      size: 145258162
    - path: data/oof/lgbm_layer_0.feather
      hash: md5
      md5: b15859f9d6cd8bac6a7ce1b311fef157
      size: 145258138
    - path: data/oof/xgboost_layer_0.feather
      hash: md5
      md5: 9ff83257916b443774b6a2938000de27
      size: 141852058
    - path: insurance/train_catboost.py
      hash: md5
      md5: e3ec18a1dc272c7e5adfd49301158f40
      size: 5502
    outs:
    - path: data/oof/catboost_layer_1.feather
      hash: md5
      md5: 03dffa9720f68ea27ee7b7d72088102f
      size: 170659138
    - path: out/models/catboost_model_layer_1.pkl
      hash: md5
      md5: 34b4e4cb196f1d5b72cb947cc36c99ca
      size: 5819441
  train_layer_0:
    cmd: poetry run python insurance/train_layer.py --layer 0
    deps:
    - path: data/prepared/test_data.feather
      hash: md5
      md5: 9c65dae12868d8646abe9faae5844859
      size: 92158186
    - path: data/prepared/train_data.feather
      hash: md5
      md5: f228b8b2ecd5070de22fa23efb59c33e
      size: 143144866
    - path: insurance/train_layer.py
      hash: md5
      md5: 7e08469d0667e8a4c2ba0f379c0e323c
      size: 2661
    params:
      params.yaml:
        layer_0:
          xgboost:
            type: xgboost
            params:
              n_estimators: 500
              learning_rate: 0.3
              max_depth: 5
              reg_lambda: 1
              reg_alpha: 0.1
              random_state: 42
              objective: reg:squarederror
              eval_metric: rmse
              device: cuda
              verbosity: 0
              enable_categorical: true
          catboost:
            type: catboost
            params:
              iterations: 200
              learning_rate: 0.33741802035300733
              depth: 5
              l2_leaf_reg: 0.6988750565188863
              loss_function: RMSE
              random_strength: 0.001326565507721897
              bagging_temperature: 0.5233508452963999
              task_type: GPU
          lgbm:
            type: lgbm
            params:
              objective: regression
              metric: rmse
              feature_pre_filter: false
              lambda_l1: 1.6575159147685196e-08
              lambda_l2: 0.0017415507514917511
              num_leaves: 67
              feature_fraction: 1.0
              bagging_fraction: 1.0
              bagging_freq: 0
              min_child_samples: 20
          lgbm_simple:
            type: lgbm
            params:
              objective: regression
              metric: rmse
              feature_pre_filter: false
    outs:
    - path: data/oof/layer_0.feather
      hash: md5
      md5: da3a033cb0af94076d9d4d2a95d32c88
      size: 161540154
    - path: data/preds/layer_0.feather
      hash: md5
      md5: 622b58d3a83b5f965022b49f0bf795f6
      size: 106762914
  train_layer_1:
    cmd: poetry run python insurance/train_layer.py --layer 1
    deps:
    - path: data/oof/layer_0.feather
      hash: md5
      md5: da3a033cb0af94076d9d4d2a95d32c88
      size: 161540154
    - path: data/preds/layer_0.feather
      hash: md5
      md5: 622b58d3a83b5f965022b49f0bf795f6
      size: 106762914
    - path: insurance/train_layer.py
      hash: md5
      md5: 7e08469d0667e8a4c2ba0f379c0e323c
      size: 2661
    params:
      params.yaml:
        layer_1:
          catboost:
            type: catboost
            params:
              iterations: 600
              loss_function: RMSE
              task_type: GPU
              random_seed: 12
          lgbm:
            type: lgbm
            params:
              objective: regression
              metric: rmse
              feature_pre_filter: false
    outs:
    - path: data/oof/layer_1.feather
      hash: md5
      md5: 4afc5c8339318d2094120922336303c7
      size: 160835146
    - path: data/preds/layer_1.feather
      hash: md5
      md5: 73f26f76e11bf64fdb1731409906a943
      size: 106831570
